<!-- UnionLedger Trading Bot Dashboard -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ü§ñ UnionLedger ‚Äî Trading Bot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .status-active { color: #10b981; }
    .status-inactive { color: #ef4444; }
    .price-up { color: #10b981; }
    .price-down { color: #ef4444; }
    .trade-buy { background-color: #dcfce7; color: #166534; }
    .trade-sell { background-color: #fee2e2; color: #991b1b; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

  <nav class="bg-blue-600 text-white p-4">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-xl font-bold">ü§ñ UnionLedger Trading Bot</h1>
      <div class="space-x-4">
        <a href="/" class="hover:underline">Home</a>
        <a href="/dashboard" class="hover:underline">Dashboard</a>
        <a href="/transfer" class="hover:underline">Transfer</a>
        <a href="/trading" class="font-bold">Trading Bot</a>
      </div>
    </div>
  </nav>

  <main class="container mx-auto p-6">
    
    <!-- Bot Control Panel -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-2xl font-bold mb-4">üéÆ Bot Control Panel</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        
        <!-- Bot Status -->
        <div class="bg-gray-50 p-4 rounded">
          <h3 class="font-semibold mb-2">Status</h3>
          <div id="bot-status" class="text-lg font-bold status-inactive">‚óè  INACTIVE</div>
        </div>
        
        <!-- Balance -->
        <div class="bg-gray-50 p-4 rounded">
          <h3 class="font-semibold mb-2">Balance</h3>
          <div id="bot-balance" class="text-lg font-bold">$0.00</div>
        </div>
        
        <!-- Active Positions -->
        <div class="bg-gray-50 p-4 rounded">
          <h3 class="font-semibold mb-2">Positions</h3>
          <div id="bot-positions" class="text-lg font-bold">0</div>
        </div>
        
      </div>
      
      <!-- Control Buttons -->
      <div class="flex gap-4 mt-6">
        <button id="start-bot" class="bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600">
          ‚ñ∂Ô∏è Start Bot
        </button>
        <button id="stop-bot" class="bg-red-500 text-white px-6 py-2 rounded hover:bg-red-600">
          ‚èπÔ∏è Stop Bot
        </button>
        <button id="refresh-status" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600">
          üîÑ Refresh
        </button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      
      <!-- Market Data -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-bold mb-4">üìà Live Market Data</h2>
        <div id="market-data" class="space-y-3">
          <!-- Market data will be populated here -->
        </div>
      </div>
      
      <!-- Trading Strategies -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-bold mb-4">üìä Trading Strategies</h2>
        <div id="strategies" class="space-y-3">
          <!-- Strategies will be populated here -->
        </div>
      </div>
      
    </div>

    <!-- Recent Trades -->
    <div class="bg-white rounded-lg shadow p-6 mt-6">
      <h2 class="text-xl font-bold mb-4">üìã Recent Trades</h2>
      <div class="overflow-x-auto">
        <table class="w-full border-collapse">
          <thead>
            <tr class="border-b">
              <th class="text-left p-2">Time</th>
              <th class="text-left p-2">Symbol</th>
              <th class="text-left p-2">Action</th>
              <th class="text-left p-2">Quantity</th>
              <th class="text-left p-2">Price</th>
              <th class="text-left p-2">Reason</th>
            </tr>
          </thead>
          <tbody id="trades-table">
            <!-- Trades will be populated here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Connection Status -->
    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded mt-6">
      <div class="flex items-center">
        <span id="connection-status">üîå Connecting to trading WebSocket...</span>
      </div>
    </div>
    
  </main>

  <script>
    // Trading Bot Dashboard JavaScript
    class TradingDashboard {
      constructor() {
        this.ws = null;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
        this.init();
      }

      init() {
        this.setupWebSocket();
        this.setupEventListeners();
        this.loadInitialData();
      }

      setupWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/trading-ws`;
        
        try {
          this.ws = new WebSocket(wsUrl);
          
          this.ws.onopen = () => {
            console.log('‚úÖ WebSocket connected');
            this.updateConnectionStatus('‚úÖ Connected to trading WebSocket', 'green');
            this.reconnectAttempts = 0;
          };

          this.ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            this.handleWebSocketMessage(message);
          };

          this.ws.onclose = () => {
            console.log('‚ùå WebSocket disconnected');
            this.updateConnectionStatus('‚ùå WebSocket disconnected', 'red');
            this.attemptReconnect();
          };

          this.ws.onerror = (error) => {
            console.error('‚ùå WebSocket error:', error);
            this.updateConnectionStatus('‚ùå WebSocket error', 'red');
          };
        } catch (error) {
          console.error('‚ùå Failed to create WebSocket:', error);
          this.updateConnectionStatus('‚ùå Failed to connect', 'red');
        }
      }

      attemptReconnect() {
        if (this.reconnectAttempts < this.maxReconnectAttempts) {
          this.reconnectAttempts++;
          console.log(`üîÑ Attempting to reconnect... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
          
          setTimeout(() => {
            this.setupWebSocket();
          }, 3000 * this.reconnectAttempts);
        } else {
          this.updateConnectionStatus('‚ùå Failed to reconnect. Refresh page to retry.', 'red');
        }
      }

      handleWebSocketMessage(message) {
        switch (message.type) {
          case 'status':
            this.updateBotStatus(message.data);
            break;
          case 'marketUpdate':
            this.updateMarketData(message.data);
            break;
          case 'tradeExecuted':
            this.addNewTrade(message.data);
            this.loadTradingHistory(); // Refresh history
            break;
          case 'botStarted':
            this.loadBotStatus();
            break;
          case 'botStopped':
            this.loadBotStatus();
            break;
        }
      }

      updateConnectionStatus(message, color = 'yellow') {
        const statusElement = document.getElementById('connection-status');
        statusElement.textContent = message;
        statusElement.parentElement.className = `flex items-center bg-${color}-100 border-l-4 border-${color}-500 text-${color}-800 p-4 rounded mt-6`;
      }

      setupEventListeners() {
        document.getElementById('start-bot').addEventListener('click', () => this.startBot());
        document.getElementById('stop-bot').addEventListener('click', () => this.stopBot());
        document.getElementById('refresh-status').addEventListener('click', () => this.loadBotStatus());
      }

      async loadInitialData() {
        await this.loadBotStatus();
        await this.loadTradingHistory();
      }

      async makeApiCall(url, options = {}) {
        try {
          const response = await fetch(url, {
            headers: {
              'Content-Type': 'application/json',
              ...options.headers
            },
            ...options
          });
          return await response.json();
        } catch (error) {
          console.error('‚ùå API call failed:', error);
          return { error: error.message };
        }
      }

      async startBot() {
        const result = await this.makeApiCall('/api/trading/start', { method: 'POST' });
        if (result.status === 'success') {
          console.log('‚úÖ Bot started');
        } else {
          console.error('‚ùå Failed to start bot:', result.message);
        }
      }

      async stopBot() {
        const result = await this.makeApiCall('/api/trading/stop', { method: 'POST' });
        if (result.status === 'success') {
          console.log('‚úÖ Bot stopped');
        } else {
          console.error('‚ùå Failed to stop bot:', result.message);
        }
      }

      async loadBotStatus() {
        const status = await this.makeApiCall('/api/trading/status');
        if (!status.error) {
          this.updateBotStatus(status);
        }
      }

      updateBotStatus(status) {
        // Update status indicator
        const statusElement = document.getElementById('bot-status');
        if (status.isActive) {
          statusElement.textContent = '‚óè ACTIVE';
          statusElement.className = 'text-lg font-bold status-active';
        } else {
          statusElement.textContent = '‚óè INACTIVE';
          statusElement.className = 'text-lg font-bold status-inactive';
        }

        // Update balance
        document.getElementById('bot-balance').textContent = `$${status.balance.toLocaleString()}`;
        
        // Update positions
        document.getElementById('bot-positions').textContent = status.positions;

        // Update strategies
        this.updateStrategies(status.strategies);
        
        // Update market data if available
        if (status.marketData) {
          this.updateMarketData(status.marketData);
        }
      }

      updateStrategies(strategies) {
        const container = document.getElementById('strategies');
        container.innerHTML = strategies.map(strategy => `
          <div class="flex justify-between items-center p-3 border rounded">
            <div>
              <div class="font-semibold">${strategy.name}</div>
              <div class="text-sm text-gray-600">${strategy.key}</div>
            </div>
            <div class="text-right">
              <span class="px-2 py-1 rounded text-xs ${strategy.enabled ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                ${strategy.enabled ? 'ENABLED' : 'DISABLED'}
              </span>
            </div>
          </div>
        `).join('');
      }

      updateMarketData(marketData) {
        const container = document.getElementById('market-data');
        const entries = Object.entries(marketData);
        
        container.innerHTML = entries.map(([symbol, data]) => {
          const changeColor = parseFloat(data.change) >= 0 ? 'price-up' : 'price-down';
          const changePrefix = parseFloat(data.change) >= 0 ? '+' : '';
          
          return `
            <div class="flex justify-between items-center p-3 border rounded">
              <div>
                <div class="font-semibold">${symbol}</div>
                <div class="text-sm text-gray-600">Vol: ${parseInt(data.volume).toLocaleString()}</div>
              </div>
              <div class="text-right">
                <div class="font-bold">$${data.price.toLocaleString()}</div>
                <div class="text-sm ${changeColor}">${changePrefix}${data.change}%</div>
              </div>
            </div>
          `;
        }).join('');
      }

      async loadTradingHistory() {
        const history = await this.makeApiCall('/api/trading/history?limit=10');
        if (!history.error) {
          this.updateTradesTable(history.trades);
        }
      }

      updateTradesTable(trades) {
        const tbody = document.getElementById('trades-table');
        tbody.innerHTML = trades.map(trade => {
          const time = new Date(trade.timestamp).toLocaleTimeString();
          const tradeClass = trade.action === 'BUY' ? 'trade-buy' : 'trade-sell';
          
          return `
            <tr class="border-b">
              <td class="p-2">${time}</td>
              <td class="p-2 font-mono">${trade.symbol}</td>
              <td class="p-2">
                <span class="px-2 py-1 rounded text-xs ${tradeClass}">
                  ${trade.action}
                </span>
              </td>
              <td class="p-2">${trade.quantity}</td>
              <td class="p-2">$${trade.price.toLocaleString()}</td>
              <td class="p-2 text-sm">${trade.reason}</td>
            </tr>
          `;
        }).join('');
      }

      addNewTrade(trade) {
        console.log('üîÑ New trade executed:', trade);
        // The table will be refreshed when loadTradingHistory is called
      }
    }

    // Initialize dashboard when page loads
    document.addEventListener('DOMContentLoaded', () => {
      new TradingDashboard();
    });
  </script>

</body>
</html>